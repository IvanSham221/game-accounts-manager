<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</title>
    <link rel="stylesheet" href="style.css?v=20250115">
    <style>
        .worker-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.3s ease;
        }
        
        .worker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .worker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .worker-info {
            flex: 1;
        }
        
        .worker-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }
        
        .worker-details {
            color: #64748b;
            font-size: 0.9em;
        }
        
        .worker-status {
            text-align: right;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-admin {
            background: linear-gradient(135deg, #f72585 0%, #e63946 100%);
            color: white;
        }
        
        .worker-stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #64748b;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .debug-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
            transition: all 0.3s ease;
        }
        
        .debug-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(255, 71, 87, 0.4);
        }
    </style>
</head>
<body>
    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
    <div id="mobileMenu" class="mobile-menu">
        <div class="mobile-menu-header">
            <div class="user-info-mobile">
                <div class="user-avatar">üë§</div>
                <div>
                    <div class="user-name" id="mobileUserName"></div>
                    <div class="user-role" id="mobileUserRole"></div>
                </div>
            </div>
            <button class="close-menu" onclick="toggleMobileMenu()">√ó</button>
        </div>
        
        <div class="mobile-menu-nav">
            <!-- –ü—É–Ω–∫—Ç—ã –º–µ–Ω—é –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        
        <div class="mobile-menu-footer">
            <button onclick="logout()" class="btn btn-danger btn-block">
                <span>üö™</span> –í—ã–π—Ç–∏
            </button>
        </div>
    </div>
  
    <!-- –ë—É—Ä–≥–µ—Ä-–∫–Ω–æ–ø–∫–∞ -->
    <div class="burger-container">
        <button class="burger-btn" onclick="toggleMobileMenu()" title="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
            <div class="burger-icon">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <!-- –ë–µ–π–¥–∂ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ -->
            <div class="burger-badge" id="menuBadge" style="display: none;">0</div>
            <!-- –¢–µ–∫—Å—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ -->
            <div class="burger-label">–ú–µ–Ω—é</div>
        </button>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>
    
    <div class="container">
        <h1><span>üëë</span><span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</span></h1>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ -->
        <div class="section">
            <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</h2>
            <div class="form-grid">
                <div>
                    <label for="workerName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">
                        –ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:
                    </label>
                    <input type="text" id="workerName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" class="input" required>
                </div>
                
                <div>
                    <label for="workerLogin" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">
                        –õ–æ–≥–∏–Ω –¥–ª—è –≤—Ö–æ–¥–∞:
                    </label>
                    <input type="text" id="workerLogin" placeholder="ivanov" class="input" required>
                </div>
                
                <div>
                    <label for="workerPassword" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">
                        –ü–∞—Ä–æ–ª—å:
                    </label>
                    <input type="password" id="workerPassword" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" class="input" required>
                </div>
                
                <div>
                    <label for="workerConfirmPassword" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:
                    </label>
                    <input type="password" id="workerConfirmPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="input" required>
                </div>
                
                <div style="grid-column: 1 / -1; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="workerActive" checked style="width: 18px; height: 18px;">
                        <span style="font-weight: 600; color: #2d3748;">–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                    </label>
                    <div style="color: #64748b; font-size: 0.9em; margin-top: 5px;">
                        –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –Ω–µ —Å–º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                    </div>
                </div>
                
                <button onclick="addWorker()" class="btn btn-success" style="grid-column: 1 / -1; padding: 15px;">
                    <span style="margin-right: 10px;">üë∑</span>
                    –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
                </button>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üìã –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h2>
                <button onclick="refreshWorkers()" class="btn btn-primary btn-small">
                    <span style="margin-right: 5px;">üîÑ</span>
                    –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
            
            <div id="workersList" class="list">
                <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤...</div>
            </div>
        </div>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏ -->
        <div class="section" style="background: #f8f9fa; border: 1px solid #dee2e6;">
            <h3>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –æ—Ç–ª–∞–¥–∫–∏</h3>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <button onclick="forceSyncWorkers()" class="btn btn-primary">
                    üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                </button>
                
                <button onclick="checkWorkersStatus()" class="btn btn-info">
                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                </button>
                
                <button onclick="backupWorkers()" class="btn btn-success">
                    üíæ –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
                </button>
            </div>
            
            <div id="debugInfo" style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #dee2e6; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                <div style="color: #6c757d; text-align: center;">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–ª–∞–¥–∫–∏
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–µ–±–∞–≥–∞ -->
    <div class="debug-panel">
        <button onclick="showDebugInfo()" class="debug-btn">üêõ –î–µ–±–∞–≥</button>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="firebase.js"></script>
    <script src="security.js"></script>
    <script src="script.js?v=20250115"></script>
    
    <script>
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WORKERS.HTML ===');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const user = security.getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (user.role !== 'admin') {
                document.body.innerHTML = `
                    <div class="container">
                        <div style="text-align: center; padding: 100px 20px;">
                            <h1 style="color: #ef4444;">‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
                            <p>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</p>
                            <button onclick="window.location.href='manager.html'" class="btn btn-primary">
                                –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            initMobileMenu();
            loadWorkers();
            setupWorkersListener();
            
            // –ù–∞—á–∏–Ω–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
            startWorkersMonitoring();
        });
        
        // ==================== –†–ê–ë–û–¢–ù–ò–ö–ò ====================
        let workers = [];
        let workersListener = null;
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function loadWorkers() {
            console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞—é —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤...');
            
            try {
                // 1. –ü—Ä–æ–±—É–µ–º –∏–∑ localStorage
                const localWorkers = JSON.parse(localStorage.getItem('workers') || '[]');
                
                // 2. –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Firebase
                if (localWorkers.length === 0 && window.dataSync && window.dataSync.loadData) {
                    console.log('üìÇ –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∑–∞–≥—Ä—É–∂–∞—é –∏–∑ Firebase...');
                    window.dataSync.loadData('workers').then(firebaseWorkers => {
                        if (firebaseWorkers && firebaseWorkers.length > 0) {
                            workers = firebaseWorkers;
                            localStorage.setItem('workers', JSON.stringify(workers));
                            displayWorkers();
                            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${workers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –∏–∑ Firebase`);
                        } else {
                            workers = localWorkers;
                            displayWorkers();
                        }
                    }).catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
                        workers = localWorkers;
                        displayWorkers();
                    });
                } else {
                    workers = localWorkers;
                    displayWorkers();
                    console.log(`üìä –õ–æ–∫–∞–ª—å–Ω–æ: ${workers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤`);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤:', error);
                document.getElementById('workersList').innerHTML = `
                    <div class="empty">
                        <div style="color: #f72585; margin-bottom: 10px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <button onclick="loadWorkers()" class="btn btn-small">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function displayWorkers() {
            const workersList = document.getElementById('workersList');
            
            if (!workers || workers.length === 0) {
                workersList.innerHTML = `
                    <div class="empty">
                        <div style="font-size: 50px; margin-bottom: 15px;">üë•</div>
                        <h3>–ù–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</p>
                    </div>
                `;
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ–¥–∞–∂ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
            const sales = JSON.parse(localStorage.getItem('sales') || '[]');
            const workerStats = {};
            
            sales.forEach(sale => {
                if (sale.soldBy && sale.soldBy !== 'unknown') {
                    if (!workerStats[sale.soldBy]) {
                        workerStats[sale.soldBy] = {
                            sales: 0,
                            revenue: 0,
                            lastSale: null
                        };
                    }
                    workerStats[sale.soldBy].sales++;
                    workerStats[sale.soldBy].revenue += sale.price;
                    
                    const saleDate = new Date(sale.datetime || sale.timestamp);
                    if (!workerStats[sale.soldBy].lastSale || saleDate > new Date(workerStats[sale.soldBy].lastSale)) {
                        workerStats[sale.soldBy].lastSale = sale.datetime || sale.timestamp;
                    }
                }
            });
            
            workersList.innerHTML = workers.map(worker => {
                const stats = workerStats[worker.username] || { sales: 0, revenue: 0, lastSale: null };
                const isAdmin = worker.role === 'admin';
                const isActive = worker.active !== false;
                const avgCheck = stats.sales > 0 ? Math.round(stats.revenue / stats.sales) : 0;
                
                return `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-info">
                                <div class="worker-name">
                                    ${worker.name}
                                    ${worker.createdBy ? `<span style="font-size: 0.8em; color: #64748b;"> (–¥–æ–±–∞–≤–∏–ª: ${worker.createdBy})</span>` : ''}
                                </div>
                                <div class="worker-details">
                                    –õ–æ–≥–∏–Ω: <strong>${worker.username}</strong> ‚Ä¢ 
                                    –î–æ–±–∞–≤–ª–µ–Ω: ${worker.created || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'} ‚Ä¢
                                    ID: ${worker.id || 'N/A'}
                                </div>
                            </div>
                            
                            <div class="worker-status">
                                <div class="status-badge ${isAdmin ? 'status-admin' : (isActive ? 'status-active' : 'status-inactive')}">
                                    ${isAdmin ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : (isActive ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω')}
                                </div>
                            </div>
                        </div>
                        
                        ${stats.sales > 0 ? `
                            <div class="worker-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${stats.sales}</div>
                                    <div class="stat-label">–ü—Ä–æ–¥–∞–∂</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${stats.revenue} ‚ÇΩ</div>
                                    <div class="stat-label">–í—ã—Ä—É—á–∫–∞</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${avgCheck} ‚ÇΩ</div>
                                    <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                                </div>
                                ${stats.lastSale ? `
                                    <div class="stat-item">
                                        <div class="stat-value">${new Date(stats.lastSale).toLocaleDateString('ru-RU')}</div>
                                        <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            ${!isAdmin ? `
                                <button class="btn btn-small ${isActive ? 'btn-warning' : 'btn-success'}" 
                                        onclick="toggleWorker('${worker.username}', ${isActive ? 'false' : 'true'})">
                                    ${isActive ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                                </button>
                                
                                <button class="btn btn-primary btn-small" onclick="resetWorkerPassword('${worker.username}')">
                                    üîë –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                </button>
                            ` : ''}
                            
                            ${!isAdmin ? `
                                <button class="btn btn-danger btn-small" onclick="deleteWorker('${worker.username}')">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function fixHashPassword(password) {
    if (!password) return '';
    
    // –ü–†–û–°–¢–û–ô –ò –°–¢–ê–ë–ò–õ–¨–ù–´–ô —Ö–µ—à
    const salt = '@PSHub_Fixed';
    let hash = 0;
    
    const salted = salt + password;
    for (let i = 0; i < salted.length; i++) {
        hash = ((hash << 5) - hash) + salted.charCodeAt(i);
    }
    
    // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    return 'fix_' + Math.abs(hash).toString(36);
}
        
        // –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function addWorker() {
    console.log('=== –ù–ê–ß–ê–õ–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –†–ê–ë–û–¢–ù–ò–ö–ê ===');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
    const name = document.getElementById('workerName').value.trim();
    const username = document.getElementById('workerLogin').value.trim().toLowerCase();
    const password = document.getElementById('workerPassword').value;
    const confirmPassword = document.getElementById('workerConfirmPassword').value;
    const active = document.getElementById('workerActive').checked;
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π
    if (!name || !username || !password) {
        showDebugInfo('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showDebugInfo('‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
        return;
    }
    
    if (password.length < 4) {
        showDebugInfo('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞!', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞
    if (workers.find(w => w.username === username)) {
        showDebugInfo('‚ùå –†–∞–±–æ—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –ª–æ–≥–∏–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏–Ω—ã
    if (username === 'admin' || username === 'ivan' || username === 'administrator') {
        showDebugInfo('‚ùå –≠—Ç–æ—Ç –ª–æ–≥–∏–Ω –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω!', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    const currentUser = security.getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
        showDebugInfo('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!', 'error');
        return;
    }
    
    // –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è - –í–°–ï–ì–î–ê –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    function fixedHashPassword(password) {
        if (!password) return '';
        
        // –ü—Ä–æ—Å—Ç–æ–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
        const salt = '@PSHub_Fixed_Salt_2025';
        let hash = 0;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–ª—å –î–û –ø–∞—Ä–æ–ª—è (—ç—Ç–æ –≤–∞–∂–Ω–æ!)
        const saltedPassword = salt + password;
        
        for (let i = 0; i < saltedPassword.length; i++) {
            const charCode = saltedPassword.charCodeAt(i);
            hash = ((hash << 5) - hash) + charCode;
            hash = Math.abs(hash & hash); // –î–µ–ª–∞–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
        }
        
        // –í—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
        return 'pshub_' + hash.toString(36) + '_' + password.length;
    }
    
    console.log('üîê –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è...');
    console.log('–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å:', password);
    const passwordHash = fixedHashPassword(password);
    console.log('–•–µ—à –ø–∞—Ä–æ–ª—è:', passwordHash);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–µ—à —Å—Ç–∞–±–∏–ª—å–Ω—ã–π
    const testHash = fixedHashPassword(password);
    if (passwordHash !== testHash) {
        console.error('‚ùå –û–®–ò–ë–ö–ê: –•–µ—à –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π!');
        showDebugInfo('‚ùå –û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!', 'error');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ —Å –í–°–ï–ú–ò –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–æ–ª—è–º–∏
    const newWorker = {
        id: Date.now(),
        name: name,
        username: username,
        password: passwordHash, // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô —Ö–µ—à!
        role: 'worker',
        active: active,
        created: new Date().toLocaleDateString('ru-RU'),
        createdBy: currentUser.name || currentUser.username,
        timestamp: new Date().toISOString(),
        lastUpdated: new Date().toISOString(),
        lastLogin: null,
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        permissions: {
            canSell: true,
            canViewAccounts: true,
            canAddComments: true,
            canViewReports: true
        },
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        passwordSet: true,
        hashMethod: 'fixed_v1',
        originalPasswordLength: password.length
    };
    
    console.log('üÜï –ù–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫:', {
        username: newWorker.username,
        name: newWorker.name,
        passwordLength: password.length,
        hash: passwordHash.substring(0, 20) + '...'
    });
    
    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä–æ–ª—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –ø–∞—Ä–æ–ª—è...');
    const testLogin = security.validateLogin(username, password);
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –≤—Ö–æ–¥–∞:', testLogin);
    
    // 3. –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
    workers.push(newWorker);
    
    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    localStorage.setItem('workers', JSON.stringify(workers));
    console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage, —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤:', workers.length);
    
    // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
    try {
        const db = firebase.database();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        await db.ref('workers/' + username).set(newWorker);
        console.log('‚úÖ –†–∞–±–æ—Ç–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase –ø–æ–¥ –∫–ª—é—á–æ–º:', username);
        
        // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å –º–∞—Å—Å–∏–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        const workersObj = {};
        workers.forEach(w => {
            workersObj[w.username] = w;
        });
        
        await db.ref('workers').set(workersObj);
        console.log('‚úÖ –í–µ—Å—å –º–∞—Å—Å–∏–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
        
        showDebugInfo(`‚úÖ –†–∞–±–æ—Ç–Ω–∏–∫ "${name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! üë∑`, 'success');
        showDebugInfo(`–õ–æ–≥–∏–Ω: <strong>${username}</strong> | –ü–∞—Ä–æ–ª—å: <strong>${password}</strong>`, 'info');
        
        // –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            console.log('üß™ –ê–≤—Ç–æ-—Ç–µ—Å—Ç –≤—Ö–æ–¥–∞...');
            const autoTest = security.validateLogin(username, password);
            console.log('–ê–≤—Ç–æ-—Ç–µ—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', autoTest);
            
            if (autoTest.success) {
                showDebugInfo('‚úÖ –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!', 'success');
            } else {
                showDebugInfo('‚ö†Ô∏è –¢–µ—Å—Ç –≤—Ö–æ–¥–∞ –Ω–µ –ø—Ä–æ—à–µ–ª: ' + (autoTest.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'warning');
            }
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
        showDebugInfo(`‚ö†Ô∏è –†–∞–±–æ—Ç–Ω–∏–∫ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (Firebase –æ—à–∏–±–∫–∞)`, 'warning');
        showDebugInfo(`–õ–æ–≥–∏–Ω: ${username} | –ü–∞—Ä–æ–ª—å: ${password}`, 'info');
    }
    
    // 6. –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('workerName').value = '';
    document.getElementById('workerLogin').value = '';
    document.getElementById('workerPassword').value = '';
    document.getElementById('workerConfirmPassword').value = '';
    
    // 7. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    displayWorkers();
    
    // 8. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏
    monitorWorkerPresence(username, name, password);
    
    // 9. –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
    createTestButton(username, password);
}

function createTestButton(username, password) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldButton = document.getElementById('testLoginButton');
    if (oldButton) oldButton.remove();
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É
    const testButton = document.createElement('button');
    testButton.id = 'testLoginButton';
    testButton.className = 'btn btn-success';
    testButton.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 1001;
        padding: 12px 20px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    `;
    testButton.innerHTML = 'üîë –¢–µ—Å—Ç –≤—Ö–æ–¥–∞';
    
    testButton.onclick = function() {
        console.log('üß™ –†—É—á–Ω–æ–π —Ç–µ—Å—Ç –≤—Ö–æ–¥–∞...');
        
        // –ü—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏
        const result = security.validateLogin(username, password);
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
        
        if (result.success) {
            showDebugInfo('‚úÖ –í–•–û–î –£–°–ü–ï–®–ï–ù! –†–∞–±–æ—Ç–Ω–∏–∫ –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.', 'success');
            
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å—Ä–∞–∑—É –≤–æ–π—Ç–∏
            if (confirm(`–£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç!\n\n–•–æ—Ç–∏—Ç–µ –≤–æ–π—Ç–∏ –∫–∞–∫ "${result.user.name}"?`)) {
                security.startSession(result.user);
                window.location.href = 'manager.html';
            }
        } else {
            showDebugInfo(`‚ùå –û–®–ò–ë–ö–ê –í–•–û–î–ê: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            const workers = JSON.parse(localStorage.getItem('workers') || '[]');
            const worker = workers.find(w => w.username === username);
            
            if (worker) {
                console.log('–î–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:', worker);
                console.log('–û–∂–∏–¥–∞–µ–º—ã–π —Ö–µ—à –ø–∞—Ä–æ–ª—è:', fixedHashPassword(password));
                console.log('–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ö–µ—à:', worker.password);
            }
        }
    };
    
    document.body.appendChild(testButton);
    
    // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã
    setTimeout(() => {
        if (testButton.parentNode) {
            testButton.remove();
        }
    }, 120000);
}

function fixAllWorkersPasswords() {
    if (!confirm('–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –í–°–ï–• —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤?\n\n–í—Å–µ –ø–∞—Ä–æ–ª–∏ –±—É–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ "1234".')) {
        return;
    }
    
    const workers = JSON.parse(localStorage.getItem('workers') || '[]');
    let fixedCount = 0;
    
    workers.forEach(worker => {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        if (worker.role === 'admin') return;
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
        worker.password = fixedHashPassword('1234');
        worker.passwordFixed = true;
        worker.fixedAt = new Date().toISOString();
        worker.originalPassword = '1234 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω)';
        fixedCount++;
    });
    
    localStorage.setItem('workers', JSON.stringify(workers));
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å Firebase
    if (firebase) {
        const workersObj = {};
        workers.forEach(w => workersObj[w.username] = w);
        firebase.database().ref('workers').set(workersObj);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    workers = workers;
    displayWorkers();
    
    showDebugInfo(`‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ${fixedCount} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!\n–¢–µ–ø–µ—Ä—å –≤—Å–µ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ —Å –ø–∞—Ä–æ–ª–µ–º: 1234`, 'success');
    
    // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞
    let workerList = '';
    workers.forEach(w => {
        if (w.passwordFixed) {
            workerList += `${w.name} (${w.username}) - –ø–∞—Ä–æ–ª—å: 1234\n`;
        }
    });
    
    alert(`–ü–∞—Ä–æ–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!\n\n${workerList}\n–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.`);
}
        
        // –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function toggleWorker(username, active) {
            if (!confirm(`${active ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —Ä–∞–±–æ—Ç–Ω–∏–∫–∞?`)) {
                return;
            }
            
            const workerIndex = workers.findIndex(w => w.username === username);
            
            if (workerIndex === -1) {
                showDebugInfo('‚ùå –†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            workers[workerIndex].active = active;
            workers[workerIndex].lastUpdated = new Date().toISOString();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem('workers', JSON.stringify(workers));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            try {
                await firebase.database().ref('workers/' + username).update({
                    active: active,
                    lastUpdated: new Date().toISOString()
                });
                
                showDebugInfo(`‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω!`, 'success');
                displayWorkers();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                showDebugInfo('‚ö†Ô∏è –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
                displayWorkers();
            }
        }
        
        // –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        function resetWorkerPassword(username) {
            const worker = workers.find(w => w.username === username);
            if (!worker) return;
            
            const newPassword = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞):');
            
            if (!newPassword || newPassword.length < 4) {
                showDebugInfo('‚ùå –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }
            
            if (confirm(`–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è ${worker.name}?`)) {
                const workerIndex = workers.findIndex(w => w.username === username);
                
                workers[workerIndex].password = security.hashPassword(newPassword);
                workers[workerIndex].lastUpdated = new Date().toISOString();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                localStorage.setItem('workers', JSON.stringify(workers));
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                firebase.database().ref('workers/' + username).update({
                    password: security.hashPassword(newPassword),
                    lastUpdated: new Date().toISOString()
                }).then(() => {
                    showDebugInfo('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω! üîë', 'success');
                    displayWorkers();
                }).catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                    showDebugInfo('‚ö†Ô∏è –ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
                    displayWorkers();
                });
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function deleteWorker(username) {
            const worker = workers.find(w => w.username === username);
            if (!worker) return;
            
            if (worker.role === 'admin') {
                showDebugInfo('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!', 'error');
                return;
            }
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ "${worker.name}"?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ –º–∞—Å—Å–∏–≤–∞
            workers = workers.filter(w => w.username !== username);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem('workers', JSON.stringify(workers));
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ Firebase
            try {
                await firebase.database().ref('workers/' + username).remove();
                showDebugInfo(`‚úÖ –†–∞–±–æ—Ç–Ω–∏–∫ "${worker.name}" —É–¥–∞–ª–µ–Ω!`, 'success');
                displayWorkers();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Firebase:', error);
                showDebugInfo('‚ö†Ô∏è –†–∞–±–æ—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ', 'warning');
                displayWorkers();
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function refreshWorkers() {
            console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤...');
            
            if (window.dataSync && window.dataSync.loadData) {
                window.dataSync.loadData('workers').then(firebaseWorkers => {
                    if (firebaseWorkers && firebaseWorkers.length > 0) {
                        workers = firebaseWorkers;
                        localStorage.setItem('workers', JSON.stringify(workers));
                        displayWorkers();
                        showDebugInfo(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${workers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –∏–∑ Firebase`, 'success');
                    } else {
                        showDebugInfo('‚ÑπÔ∏è –í Firebase –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞—Ö', 'info');
                    }
                }).catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    showDebugInfo('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase', 'error');
                });
            } else {
                loadWorkers();
                showDebugInfo('‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ localStorage', 'info');
            }
        }
        
        // ==================== –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –û–¢–õ–ê–î–ö–ò ====================
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        async function forceSyncWorkers() {
            showDebugInfo('üîÑ –ù–∞—á–∏–Ω–∞—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...', 'info');
            
            try {
                const db = firebase.database();
                const workersObj = {};
                
                workers.forEach(w => {
                    workersObj[w.username] = w;
                });
                
                await db.ref('workers').set(workersObj);
                showDebugInfo(`‚úÖ ${workers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å Firebase`, 'success');
                
            } catch (error) {
                showDebugInfo(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        function checkWorkersStatus() {
            const localCount = workers.length;
            
            firebase.database().ref('workers').once('value').then(snap => {
                const fbData = snap.val() || {};
                const fbCount = Object.keys(fbData).length;
                
                const info = `
                    <strong>üìä –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</strong><br>
                    üìÅ –õ–æ–∫–∞–ª—å–Ω–æ: ${localCount} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤<br>
                    üî• Firebase: ${fbCount} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤<br>
                    ${localCount === fbCount ? '‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ' : '‚ö†Ô∏è –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö!'}
                    <br><br>
                    <strong>–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏ (${localCount}):</strong><br>
                    ${workers.map(w => `‚Ä¢ ${w.name} (${w.username}) - ${w.active ? '‚úÖ' : '‚ùå'}`).join('<br>') || '–ù–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤'}
                `;
                
                showDebugInfo(info, 'info');
            }).catch(error => {
                showDebugInfo(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Firebase: ${error.message}`, 'error');
            });
        }
        
        // –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
        function backupWorkers() {
            const backup = {
                date: new Date().toISOString(),
                count: workers.length,
                workers: workers
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workers_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showDebugInfo(`‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω (${workers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤)`, 'success');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç–ª–∞–¥–∫–∏
        function showDebugInfo(message, type = 'info') {
            const debugInfo = document.getElementById('debugInfo');
            const time = new Date().toLocaleTimeString();
            
            let color = '#6c757d';
            if (type === 'success') color = '#28a745';
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';
            if (type === 'info') color = '#17a2b8';
            
            debugInfo.innerHTML = `
                <div style="color: ${color}; margin-bottom: 5px;">
                    <strong>[${time}]</strong> ${message}
                </div>
                ${debugInfo.innerHTML}
            `;
            
            // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                const divs = debugInfo.querySelectorAll('div');
                if (divs.length > 10) {
                    debugInfo.removeChild(divs[divs.length - 1]);
                }
            }, 30000);
        }
        
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        function monitorWorkerPresence(username, name, password) {
    console.log(`üëÅÔ∏è –ù–∞—á–∏–Ω–∞—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ ${username}...`);
    
    let checks = 0;
    const maxChecks = 15; // 30 —Å–µ–∫—É–Ω–¥ (15 * 2 —Å–µ–∫—É–Ω–¥—ã)
    const testPassword = password;
    
    const interval = setInterval(() => {
        checks++;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤ localStorage
        const currentWorkers = JSON.parse(localStorage.getItem('workers') || '[]');
        const existsLocally = currentWorkers.find(w => w.username === username);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞
        const canLogin = security.validateLogin(username, testPassword).success;
        
        console.log(`[${checks}] ${username}:`);
        console.log('  - –í localStorage:', existsLocally ? '‚úÖ –µ—Å—Ç—å' : '‚ùå –Ω–µ—Ç');
        console.log('  - –ú–æ–∂–µ—Ç –≤–æ–π—Ç–∏:', canLogin ? '‚úÖ –¥–∞' : '‚ùå –Ω–µ—Ç');
        
        if (!existsLocally) {
            console.error(`üö® –†–ê–ë–û–¢–ù–ò–ö ${username} –ü–†–û–ü–ê–õ –ò–ó LOCALSTORAGE!`);
            showDebugInfo(`üö® "${name}" –ø—Ä–æ–ø–∞–ª –∏–∑ localStorage!`, 'error');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            if (workers.find(w => w.username === username)) {
                localStorage.setItem('workers', JSON.stringify(workers));
                console.log('üîÑ –†–∞–±–æ—Ç–Ω–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –ø–∞–º—è—Ç–∏');
            }
        }
        
        if (!canLogin) {
            console.warn(`‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ–π—Ç–∏ –ø–æ–¥ ${username}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–µ—à
            const worker = currentWorkers.find(w => w.username === username);
            if (worker) {
                console.log('  –•–µ—à –≤ –±–∞–∑–µ:', worker.password);
                console.log('  –û–∂–∏–¥–∞–µ–º—ã–π —Ö–µ—à:', fixedHashPassword(testPassword));
            }
        }
        
        if (checks >= maxChecks) {
            clearInterval(interval);
            console.log('üëÅÔ∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω');
            
            // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
            const finalTest = security.validateLogin(username, testPassword);
            if (finalTest.success) {
                showDebugInfo(`üéâ –†–∞–±–æ—Ç–Ω–∏–∫ "${name}" –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!`, 'success');
            } else {
                showDebugInfo(`‚ö†Ô∏è –†–∞–±–æ—Ç–Ω–∏–∫ "${name}" —Å–æ–∑–¥–∞–Ω, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–æ –≤—Ö–æ–¥–æ–º`, 'warning');
            }
        }
    }, 2000);
}
        
        // –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function startWorkersMonitoring() {
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                const currentWorkers = JSON.parse(localStorage.getItem('workers') || '[]');
                const currentCount = currentWorkers.length;
                
                if (currentCount !== workers.length) {
                    console.log(`üìà –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤: –±—ã–ª–æ ${workers.length}, —Å—Ç–∞–ª–æ ${currentCount}`);
                    
                    if (currentCount < workers.length) {
                        // –ö—Ç–æ-—Ç–æ –ø—Ä–æ–ø–∞–ª
                        const lostWorkers = workers.filter(w => 
                            !currentWorkers.find(cw => cw.username === w.username)
                        );
                        
                        if (lostWorkers.length > 0) {
                            console.warn('üö® –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∏:', lostWorkers.map(w => w.username));
                            showDebugInfo(`üö® –ü–æ—Ç–µ—Ä—è–Ω–æ ${lostWorkers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤!`, 'error');
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—à –º–∞—Å—Å–∏–≤
                    workers = currentWorkers;
                }
            }, 5000);
        }
        
        // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function setupWorkersListener() {
            try {
                // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å
                if (workersListener) {
                    firebase.database().ref('workers').off('value', workersListener);
                }
                
                // –í–∫–ª—é—á–∞–µ–º –Ω–æ–≤—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                workersListener = firebase.database().ref('workers').on('value', (snapshot) => {
                    console.log('üëÇ Firebase —Å–ª—É—à–∞—Ç–µ–ª—å —Å—Ä–∞–±–æ—Ç–∞–ª');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        if (snapshot.exists()) {
                            const workersObj = snapshot.val();
                            const firebaseWorkers = Object.values(workersObj || {});
                            
                            console.log(`üîÑ –ü–æ–ª—É—á–µ–Ω–æ ${firebaseWorkers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –∏–∑ Firebase`);
                            
                            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –∑–∞–º–µ–Ω—ã
                            const localWorkers = JSON.parse(localStorage.getItem('workers') || '[]');
                            const mergedWorkers = mergeWorkers(localWorkers, firebaseWorkers);
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
                            localStorage.setItem('workers', JSON.stringify(mergedWorkers));
                            workers = mergedWorkers;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º UI
                            displayWorkers();
                            
                            showDebugInfo(`üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${mergedWorkers.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤`, 'info');
                        }
                    }, 5000); // –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥
                });
                
                console.log('‚úÖ –°–ª—É—à–∞—Ç–µ–ª—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª—è:', error);
            }
        }
        
        // –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function mergeWorkers(localWorkers, firebaseWorkers) {
            const workerMap = new Map();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
            localWorkers.forEach(worker => {
                if (worker.username) {
                    workerMap.set(worker.username, worker);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∏–∑ Firebase
            firebaseWorkers.forEach(fbWorker => {
                if (fbWorker.username) {
                    const existingWorker = workerMap.get(fbWorker.username);
                    
                    if (existingWorker) {
                        // –û–±—ä–µ–¥–∏–Ω—è–µ–º, —Å–æ—Ö—Ä–∞–Ω—è—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏
                        workerMap.set(fbWorker.username, {
                            ...fbWorker,
                            password: existingWorker.password || fbWorker.password,
                            active: existingWorker.active !== undefined ? existingWorker.active : fbWorker.active,
                            lastSynced: new Date().toISOString()
                        });
                    } else {
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ
                        workerMap.set(fbWorker.username, {
                            ...fbWorker,
                            lastSynced: new Date().toISOString()
                        });
                    }
                }
            });
            
            return Array.from(workerMap.values());
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç–ª–∞–¥–∫–∏
        function showDebugInfo() {
            console.log('=== DEBUG –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===');
            console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤:', workers.length);
            console.log('workers –º–∞—Å—Å–∏–≤:', workers);
            console.log('localStorage workers:', JSON.parse(localStorage.getItem('workers') || '[]'));
            
            firebase.database().ref('workers').once('value').then(snap => {
                const fbData = snap.val() || {};
                console.log('Firebase workers:', fbData);
                console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ Firebase:', Object.keys(fbData).length);
            });
        }
        
        // ==================== –ú–û–ë–ò–õ–¨–ù–û–ï –ú–ï–ù–Æ ====================
        
        function initMobileMenu() {
            const user = security.getCurrentUser();
            if (!user) return;
            
            document.getElementById('mobileUserName').textContent = user.name;
            document.getElementById('mobileUserRole').textContent = 
                user.role === 'admin' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä üëë' : '–†–∞–±–æ—Ç–Ω–∏–∫ üë∑';
            
            const currentPage = window.location.pathname.split('/').pop();
            const menuItems = [
                { icon: 'üéÆ', text: '–ü–∞–Ω–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞', page: 'manager.html' },
                { icon: '‚ûï', text: '–î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç', page: 'add-account.html' },
                { icon: 'üìã', text: '–°–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤', page: 'accounts.html' },
                { icon: 'üÜì', text: '–°–≤–æ–±–æ–¥–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã', page: 'free-accounts.html' },
                { icon: 'üéØ', text: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–∞–º–∏', page: 'games.html' },
                { icon: 'üìä', text: '–û—Ç—á–µ—Ç—ã', page: 'reports.html' },
                { icon: 'üìà', text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤', page: 'workers-stats.html' },
                { icon: 'üî•', text: '–ê–∫—Ü–∏–∏ PS Store', page: 'discounts.html' },
                { icon: 'üëë', text: '–†–∞–±–æ—Ç–Ω–∏–∫–∏', page: 'workers.html' }
            ];
            
            const menuNav = document.querySelector('.mobile-menu-nav');
            menuNav.innerHTML = '';
            
            menuItems.forEach(item => {
                const menuItem = document.createElement('a');
                menuItem.className = `mobile-menu-item ${currentPage === item.page ? 'active' : ''}`;
                menuItem.href = item.page;
                menuItem.onclick = closeMobileMenu;
                
                menuItem.innerHTML = `
                    <span style="margin-right: 15px; font-size: 1.3rem;">${item.icon}</span>
                    <span>${item.text}</span>
                `;
                
                menuNav.appendChild(menuItem);
            });
        }
        
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            const burgerBtn = document.querySelector('.burger-btn');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
            burgerBtn.classList.toggle('active');
            
            if (menu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        
        function closeMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('menuOverlay');
            const burgerBtn = document.querySelector('.burger-btn');
            
            menu.classList.remove('active');
            overlay.classList.remove('active');
            burgerBtn.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function logout() {
            security.logout();
        }
    </script>
</body>
</html>