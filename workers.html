<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</title>
    <link rel="stylesheet" href="style.css?v=20250115">
</head>
<body>
    <div class="container">
        <h1><span>üëë</span><span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</span></h1>
        
        <div class="nav-buttons"></div>

        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ -->
        <div id="accessCheck">
            <div class="section">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading">‚è≥</div>
                    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="adminContent" style="display: none;">
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ -->
            <div class="section">
                <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</h2>
                <div class="form-grid">
                    <input type="text" id="workerName" placeholder="–ò–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞" class="input" required>
                    <input type="text" id="workerLogin" placeholder="–õ–æ–≥–∏–Ω" class="input" required>
                    <input type="password" id="workerPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="input" required>
                    <input type="password" id="workerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" class="input" required>
                    
                    <div style="grid-column: 1 / -1; padding: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="workerActive" checked>
                            <span>–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                        </label>
                    </div>
                    
                    <button onclick="addWorker()" class="btn btn-success" style="grid-column: 1 / -1;">
                        –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
                    </button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ -->
            <div class="section">
                <h2>üìã –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h2>
                <div id="workersList" class="list">
                    <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="firebase.js"></script>
    <script src="security.js"></script>
    <script src="script.js?v=20250115"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        function checkAdminAccess() {
            const user = security.getCurrentUser();
            
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            if (user.role !== 'admin') {
                document.getElementById('accessCheck').innerHTML = `
                    <div class="section">
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 60px; margin-bottom: 20px;">üö´</div>
                            <h2>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
                            <p style="margin: 15px 0;">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞–º–∏</p>
                            <button onclick="location.href='manager.html'" class="btn btn-primary">
                                –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ø–∞–Ω–µ–ª—å
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            document.getElementById('accessCheck').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
            loadWorkers();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        async function loadWorkers() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º dataSync –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                const workers = await dataSync.forceSyncWorkers();
                displayWorkers(workers);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤:', error);
                document.getElementById('workersList').innerHTML = `
                    <div class="empty">
                        <div style="color: #f72585; margin-bottom: 10px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                        <button onclick="loadWorkers()" class="btn btn-small">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
        function displayWorkers(workers) {
            const workersList = document.getElementById('workersList');
            const user = security.getCurrentUser();
            
            if (workers.length === 0) {
                workersList.innerHTML = `
                    <div class="empty">
                        <div style="font-size: 50px; margin-bottom: 15px;">üë•</div>
                        <h3>–ù–µ—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</p>
                    </div>
                `;
                return;
            }
            
            workersList.innerHTML = workers.map(worker => `
                <div class="item" style="margin-bottom: 15px; padding: 20px; border-radius: 10px; background: rgba(255,255,255,0.8); border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>${worker.name}</strong>
                            <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                                –õ–æ–≥–∏–Ω: ${worker.username} | 
                                –î–æ–±–∞–≤–ª–µ–Ω: ${worker.created || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </div>
                        </div>
                        <div>
                            <span style="padding: 4px 10px; border-radius: 20px; font-size: 0.85em; background: ${worker.active ? '#e8f5e9' : '#ffebee'}; color: ${worker.active ? '#2e7d32' : '#c62828'};">
                                ${worker.active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </div>
                    </div>
                    
                    ${worker.username !== 'admin' && worker.username !== user.username ? `
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-small ${worker.active ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleWorker('${worker.username}', ${!worker.active})">
                                ${worker.active ? '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}
                            </button>
                            <button class="btn btn-danger btn-small" 
                                    onclick="deleteWorker('${worker.username}')">
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    ` : worker.username === user.username ? `
                        <div style="margin-top: 10px; color: #4361ee; font-weight: 500;">
                            üë§ –≠—Ç–æ –≤—ã
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function addWorker() {
            const name = document.getElementById('workerName').value.trim();
            const username = document.getElementById('workerLogin').value.trim();
            const password = document.getElementById('workerPassword').value;
            const confirmPassword = document.getElementById('workerConfirmPassword').value;
            const active = document.getElementById('workerActive').checked;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!name || !username || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            if (password.length < 4) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            if (username === 'admin') {
                alert('–õ–æ–≥–∏–Ω "admin" –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ dataSync
            let workers = await dataSync.forceSyncWorkers();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ª–æ–≥–∏–Ω–∞
            if (workers.find(w => w.username === username)) {
                alert('–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
            workers.push({
                name: name,
                username: username,
                password: password,
                active: active,
                created: new Date().toLocaleString('ru-RU'),
                role: 'worker',
                createdBy: JSON.parse(localStorage.getItem('currentUser')).username
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ dataSync (–æ–Ω —Å–∞–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å Firebase)
            const result = await dataSync.saveWorkers(workers);
            
            if (result.success) {
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('workerName').value = '';
                document.getElementById('workerLogin').value = '';
                document.getElementById('workerPassword').value = '';
                document.getElementById('workerConfirmPassword').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                loadWorkers();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                alert(`–†–∞–±–æ—Ç–Ω–∏–∫ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω! ${result.synced ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–±–ª–∞–∫–æ–º.' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.'}`);
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }
        
        // –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function toggleWorker(username, active) {
            if (!confirm(`${active ? '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'} —Ä–∞–±–æ—Ç–Ω–∏–∫–∞?`)) {
                return;
            }
            
            let workers = await dataSync.forceSyncWorkers();
            const workerIndex = workers.findIndex(w => w.username === username);
            
            if (workerIndex === -1) {
                alert('–†–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            workers[workerIndex].active = active;
            const result = await dataSync.saveWorkers(workers);
            
            if (result.success) {
                loadWorkers();
                alert(`–°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω! ${result.synced ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–±–ª–∞–∫–æ–º.' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.'}`);
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }
        
        // –£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        async function deleteWorker(username) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞?')) {
                return;
            }
            
            let workers = await dataSync.forceSyncWorkers();
            workers = workers.filter(w => w.username !== username);
            
            const result = await dataSync.saveWorkers(workers);
            
            if (result.success) {
                loadWorkers();
                alert(`–†–∞–±–æ—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω! ${result.synced ? '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–±–ª–∞–∫–æ–º.' : '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ.'}`);
            } else {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }
        
        // –°—Ç–∏–ª–∏
        const style = document.createElement('style');
        style.textContent = `
            .loading {
                font-size: 40px;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            
            .btn-warning {
                background: #ff9800;
                color: white;
            }
            
            .empty {
                text-align: center;
                padding: 40px 20px;
                color: #666;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>